From 329788af436fbfce38c9a689cefb842d7bc2f9c8 Mon Sep 17 00:00:00 2001
From: tany <tanizawa@web-tips.co.jp>
Date: Tue, 8 Aug 2017 23:30:03 +0900
Subject: [PATCH] [add] site_export spec (#1562)

* [add] site_export spec

* [refactor] for rubocop
---
 app/jobs/sys/site_export/zip.rb          |  2 +-
 spec/jobs/sys/site_export/export_spec.rb | 25 +++++++++++++++++++++++++
 2 files changed, 26 insertions(+), 1 deletion(-)
 create mode 100644 spec/jobs/sys/site_export/export_spec.rb

diff --git a/app/jobs/sys/site_export/zip.rb b/app/jobs/sys/site_export/zip.rb
index 54df67e5..98613750 100644
--- a/app/jobs/sys/site_export/zip.rb
+++ b/app/jobs/sys/site_export/zip.rb
@@ -11,7 +11,7 @@ class Sys::SiteExport::Zip
     Zip::File.open(@path, Zip::File::CREATE) do |zip|
       add_json(zip)
       add_private_files(zip)
-      add_public_files(zip)
+      add_public_files(zip) if FileTest.directory?(@site_dir)
     end
   end
 
diff --git a/spec/jobs/sys/site_export/export_spec.rb b/spec/jobs/sys/site_export/export_spec.rb
new file mode 100644
index 00000000..27338871
--- /dev/null
+++ b/spec/jobs/sys/site_export/export_spec.rb
@@ -0,0 +1,25 @@
+require 'spec_helper'
+require 'rake'
+
+describe Sys::SiteExportJob, dbscope: :example do
+  let(:site) { cms_site }
+  let(:job) { Sys::SiteExportJob.new }
+  let(:zip) { job.instance_variable_get(:@output_zip) }
+
+  before do
+    task = OpenStruct.new(source_site_id: site.id)
+    def task.log(msg)
+      puts(msg)
+    end
+    job.task = task
+    job.perform
+  end
+
+  context 'site export' do
+    it { expect(File.exist?(zip)).to be_truthy }
+  end
+
+  after do
+    FileUtils.rm(zip)
+  end
+end
-- 
2.13.4

